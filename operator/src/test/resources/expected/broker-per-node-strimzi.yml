---
kind: "Kafka"
metadata:
  annotations: {}
  labels:
    app.kubernetes.io/managed-by: "kas-fleetshard-operator"
    managedkafka.bf2.org/strimziVersion: "0.23.0-2"
    ingressType: "sharded"
    managedkafka.bf2.org/kas-zone2: "true"
    managedkafka.bf2.org/kas-multi-zone: "true"
    managedkafka.bf2.org/kas-zone0: "true"
    managedkafka.bf2.org/kas-zone1: "true"
  name: "test-mk"
  namespace: "test"
  ownerReferences:
  - apiVersion: "managedkafka.bf2.org/v1alpha1"
    kind: "ManagedKafka"
    name: "test-mk"
spec:
  kafka:
    version: "2.6.0"
    replicas: 3
    listeners:
    - name: "tls"
      port: 9093
      type: "internal"
      tls: true
      authentication: !<oauth>
        clientId: "clientId"
        clientSecret:
          secretName: "test-mk-sso-secret"
          key: "ssoClientSecret"
        validIssuerUri: "https://validIssuerEndpointURI"
        checkIssuer: true
        jwksEndpointUri: "https://jwksEndpointURI"
        userNameClaim: "userNameClaim"
        checkAccessTokenType: true
        accessTokenIsJwt: true
        tlsTrustedCertificates:
        - secretName: "test-mk-sso-cert"
          certificate: "keycloak.crt"
        enablePlain: true
        tokenEndpointUri: "https://tokenEndpointURI"
        enableOauthBearer: true
        type: "oauth"
    - name: "external"
      port: 9094
      type: "ingress"
      tls: true
      authentication: !<oauth>
        clientId: "clientId"
        clientSecret:
          secretName: "test-mk-sso-secret"
          key: "ssoClientSecret"
        validIssuerUri: "https://validIssuerEndpointURI"
        checkIssuer: true
        jwksEndpointUri: "https://jwksEndpointURI"
        userNameClaim: "userNameClaim"
        checkAccessTokenType: true
        accessTokenIsJwt: true
        tlsTrustedCertificates:
        - secretName: "test-mk-sso-cert"
          certificate: "keycloak.crt"
        enablePlain: true
        tokenEndpointUri: "https://tokenEndpointURI"
        enableOauthBearer: true
        type: "oauth"
      configuration:
        bootstrap:
          host: "xxx.yyy.zzz"
        brokers:
        - broker: 0
          host: "broker-0-xxx.yyy.zzz"
        - broker: 1
          host: "broker-1-xxx.yyy.zzz"
        - broker: 2
          host: "broker-2-xxx.yyy.zzz"
        maxConnections: 166
        maxConnectionCreationRate: 33
    - name: "oauth"
      port: 9095
      type: "internal"
      tls: false
      authentication: !<oauth>
        clientId: "clientId"
        clientSecret:
          secretName: "test-mk-sso-secret"
          key: "ssoClientSecret"
        validIssuerUri: "https://validIssuerEndpointURI"
        checkIssuer: true
        jwksEndpointUri: "https://jwksEndpointURI"
        userNameClaim: "userNameClaim"
        checkAccessTokenType: true
        accessTokenIsJwt: true
        tlsTrustedCertificates:
        - secretName: "test-mk-sso-cert"
          certificate: "keycloak.crt"
        enableOauthBearer: true
        type: "oauth"
    - name: "sre"
      port: 9096
      type: "internal"
      tls: false
    config:
      strimzi.authorization.custom-authorizer.acl.8: "permission=allow;principal=userid-123;transactional_id=*;operations=all"
      auto.create.topics.enable: "false"
      strimzi.authorization.custom-authorizer.acl.4: "default=true;permission=allow;transactional_id=*;operations=all"
      strimzi.authorization.custom-authorizer.acl.5: "permission=allow;principal=userid-123;cluster=*;operations=describe,alter;apis=create_acls,describe_acls,delete_acls"
      strimzi.authorization.custom-authorizer.acl.6: "permission=allow;principal=userid-123;topic=*;operations=all"
      strimzi.authorization.custom-authorizer.acl.7: "permission=allow;principal=userid-123;group=*;operations=all"
      strimzi.authorization.custom-authorizer.acl.1: "permission=deny;listeners=EXTERNAL.*;cluster=*;operations=all"
      min.insync.replicas: 2
      strimzi.authorization.custom-authorizer.acl.2: "default=true;permission=allow;topic=*;operations=all"
      offsets.topic.replication.factor: 3
      strimzi.authorization.custom-authorizer.acl.3: "default=true;permission=allow;group=*;operations=all"
      transaction.state.log.min.isr: 2
      client.quota.callback.static.storage.soft: "28991029248"
      default.replication.factor: 3
      inter.broker.protocol.version: "2.6.0"
      client.quota.callback.static.produce: "699050"
      client.quota.callback.static.fetch: "699050"
      client.quota.callback.static.disable-quota-anonymous: "true"
      ssl.protocol: "TLS"
      client.quota.callback.class: "io.strimzi.kafka.quotas.StaticQuotaCallback"
      transaction.state.log.replication.factor: 3
      log.message.format.version: "2.6.0"
      ssl.enabled.protocols: "TLSv1.3,TLSv1.2"
      quota.window.size.seconds: "2"
      strimzi.authorization.custom-authorizer.allowed-listeners: "SRE-9096"
      quota.window.num: "30"
      client.quota.callback.static.storage.hard: "30601641984"
      client.quota.callback.static.storage.check-interval: "30"
      strimzi.authorization.custom-authorizer.resource-operations: "{ \"cluster\"\
        : [ \"describe\", \"alter\" ], \"group\": [ \"all\", \"delete\", \"describe\"\
        , \"read\" ], \"topic\": [ \"all\", \"alter\", \"alter_configs\", \"create\"\
        , \"delete\", \"describe\", \"describe_configs\", \"read\", \"write\" ], \"\
        transactional_id\": [ \"all\", \"describe\", \"write\" ] }"
      leader.imbalance.per.broker.percentage: 0
    storage: !<jbod>
      volumes:
      - !<persistent-claim>
        type: "persistent-claim"
        size: "32212254720"
        class: "gp2"
        deleteClaim: true
        id: 0
      type: "jbod"
    authorization: !<custom>
      type: "custom"
      authorizerClass: "io.bf2.kafka.authorizer.CustomAclAuthorizer"
    rack:
      topologyKey: "topology.kubernetes.io/zone"
    jvmOptions:
      "-Xmx": "3G"
      "-Xms": "3G"
      "-XX":
        ExitOnOutOfMemoryError: "true"
    resources:
      limits:
        memory: "8Gi"
        cpu: "3000m"
      requests:
        memory: "8Gi"
        cpu: "3000m"
    metricsConfig: !<jmxPrometheusExporter>
      type: "jmxPrometheusExporter"
      valueFrom:
        configMapKeyRef:
          key: "jmx-exporter-config"
          name: "test-mk-kafka-metrics"
    logging:
      type: external
      valueFrom:
        configMapKeyRef:
          key: log4j.properties
          name: test-mk-kafka-logging
          optional: false
    template:
      pod:
        affinity:
          podAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
            - podAffinityTerm:
                labelSelector:
                  matchLabels:
                    strimzi.io/name: "test-mk-zookeeper"
                topologyKey: "kubernetes.io/hostname"
              weight: 50
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app.kubernetes.io/name: "kafka"
              topologyKey: "kubernetes.io/hostname"
        tolerations:
        - effect: "NoExecute"
          key: "org.bf2.operator/kafka-broker"
          operator: "Exists"
        topologySpreadConstraints:
        - labelSelector:
            matchLabels:
              strimzi.io/name: "test-mk-kafka"
          maxSkew: 1
          topologyKey: "topology.kubernetes.io/zone"
          whenUnsatisfiable: "DoNotSchedule"
  zookeeper:
    replicas: 3
    storage: !<persistent-claim>
      type: "persistent-claim"
      size: "10Gi"
      class: "gp2"
      deleteClaim: true
    jvmOptions:
      "-Xmx": "2G"
      "-Xms": "2G"
      "-XX":
        ExitOnOutOfMemoryError: "true"
    resources:
      limits:
        memory: "4Gi"
        cpu: "1000m"
      requests:
        memory: "4Gi"
        cpu: "1000m"
    metricsConfig: !<jmxPrometheusExporter>
      type: "jmxPrometheusExporter"
      valueFrom:
        configMapKeyRef:
          key: "jmx-exporter-config"
          name: "test-mk-zookeeper-metrics"
    logging:
      type: external
      valueFrom:
        configMapKeyRef:
          key: log4j.properties
          name: test-mk-zookeeper-logging
          optional: false          
    template:
      pod:
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
            - topologyKey: "kubernetes.io/hostname"
            - topologyKey: "topology.kubernetes.io/zone"
  kafkaExporter:
    resources:
      limits:
        memory: "256Mi"
        cpu: "1000m"
      requests:
        memory: "128Mi"
        cpu: "500m"
    template:
      pod:
        affinity:
          podAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  strimzi.io/name: "test-mk-zookeeper"
              topologyKey: "kubernetes.io/hostname"